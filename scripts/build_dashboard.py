#!/usr/bin/env python3
"""Build the README dashboard table from individual JSON assessment files."""

from __future__ import annotations

import json
import sys
from pathlib import Path

HEADER = """# Scorecard Results

Engineering harness grades for [markmishaev76](https://github.com/markmishaev76) repositories, generated by [AI Harness Scorecard](https://github.com/markmishaev76/ai-harness-scorecard).

> Last updated: {timestamp}

## Dashboard

| Repository | Badge | Score | Passed | Report |
|------------|-------|-------|--------|--------|
"""

FOOTER = """
## About

Each repository is assessed against 31 checks across 5 categories:
- **Architectural Documentation** (20%) -- ARCHITECTURE.md, agent instructions, ADRs, module boundaries
- **Mechanical Constraints** (25%) -- CI, linters, formatters, type safety, dependency auditing
- **Testing & Stability** (25%) -- test suites, coverage, mutation testing, fuzz testing, contract tests
- **Review & Drift Prevention** (15%) -- code review, scheduled CI, stale docs, automated review
- **AI-Specific Safeguards** (15%) -- AI norms, small batches, design-before-code, error handling

Grades: **A** (85-100), **B** (70-84), **C** (55-69), **D** (40-54), **F** (0-39)
"""

GRADE_EMOJI = {"A": "ðŸŸ¢", "B": "ðŸ”µ", "C": "ðŸŸ¡", "D": "ðŸŸ ", "F": "ðŸ”´"}


def build_dashboard(reports_dir: Path, output: Path) -> None:
    json_files = sorted(reports_dir.glob("*.json"))
    if not json_files:
        print("No JSON reports found", file=sys.stderr)
        sys.exit(1)

    rows: list[dict] = []
    for jf in json_files:
        data = json.loads(jf.read_text())
        rows.append(data)

    rows.sort(key=lambda r: r.get("overall_score", 0), reverse=True)

    timestamp = rows[0].get("timestamp", "unknown")[:19].replace("T", " ") + " UTC"

    badge_base = "https://img.shields.io/endpoint?url=https%3A%2F%2Fraw.githubusercontent.com%2Fmarkmishaev76%2Fscorecard-results%2Fmain%2Fbadges%2F"

    lines = HEADER.format(timestamp=timestamp)
    for row in rows:
        name = row["repo_name"]
        score = row["overall_score"]
        passed = row["passed_checks"]
        total = row["total_checks"]
        badge_url = f"{badge_base}{name}.json"
        badge_img = f"![score]({badge_url})"
        report_link = f"[details](reports/{name}.md)"
        lines += f"| [{name}](https://github.com/markmishaev76/{name}) | {badge_img} | {score:.1f}/100 | {passed}/{total} | {report_link} |\n"

    lines += FOOTER
    output.write_text(lines)
    print(f"Dashboard written to {output}")


if __name__ == "__main__":
    reports_dir = Path(sys.argv[1]) if len(sys.argv) > 1 else Path("reports")
    output_file = Path(sys.argv[2]) if len(sys.argv) > 2 else Path("README.md")
    build_dashboard(reports_dir, output_file)
